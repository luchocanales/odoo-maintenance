<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_maintenance_technical">
        <t t-call="web.external_layout">
            <t t-set="o" t-value="doc"/>
            <t t-set="company" t-value="o.company_id"/>
            <div class="page">

                <h2 style="text-align:center;">
                    INFORME TÉCNICO<t t-esc="o.technical_report_number"/>
                </h2>

                <!-- 1. DATOS GENERALES (se obtiene de la solicitud) -->
                <div style="margin-top:10px;">
                    <h4>1. DATOS GENERALES</h4>
                </div>
                <table class="table table-sm" style="width:100%; border:1px solid #000;">
                    <tbody>
                        <tr>
                            <td style="border:1px solid #000; width:15%;"><strong>Área:</strong></td>
                            <td style="border:1px solid #000; width:35%;">
                                <t t-esc="o.maintenance_team_id.name if o.maintenance_team_id else ''"/>
                            </td>
                            <td style="border:1px solid #000; width:20%;"><strong>Fecha de Inspección:</strong></td>
                            <td style="border:1px solid #000; width:30%;">
                                <t t-esc="o._get_schedule_date_str()"/>
                            </td>
                        </tr>
                        <tr>
                            <td style="border:1px solid #000;"><strong>Supervisor:</strong></td>
                            <td style="border:1px solid #000;">
                                <t t-esc="o.supervisor_employee_id.name"/>
                            </td>
                            <td style="border:1px solid #000;"><strong>Evaluador:</strong></td>
                            <td style="border:1px solid #000;">
                                <t t-esc="o.responsible_employee_id.name"/>
                            </td>
                        </tr>
                        <tr>
                            <td style="border:1px solid #000;"><strong>Dirigido a:</strong></td>
                            <td style="border:1px solid #000;" colspan="3">
                                <t t-set="partner_name"
                                   t-value="(
                                       ('workshop_partner_id' in o._fields and o.workshop_partner_id and o.workshop_partner_id.name)
                                       or
                                       ('order_id' in o._fields and o.order_id and 'partner_id' in o.order_id._fields and o.order_id.partner_id and o.order_id.partner_id.name)
                                       or
                                       ''
                                   )"/>
                                <t t-esc="partner_name"/>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- 2. DATOS DEL EQUIPO (del mantenimiento) -->
                <table class="table table-sm" style="width:100%; border:1px solid #000; margin-top:10px;">
                    <div style="margin-top:10px;">
                        <h4>2. DATOS DEL EQUIPO</h4>
                    </div>
                    <tbody>
                        <t t-if="'fleet_vehicle_id' in o._fields and o.fleet_vehicle_id">
                            <tr>
                                <td style="border:1px solid #000; width:12%;"><strong>Unidad:</strong></td>
                                <td style="border:1px solid #000; width:21%;">
                                    <t t-esc="o.fleet_vehicle_id.vehicle_type if 'vehicle_type' in o.fleet_vehicle_id._fields else ''"/>
                                </td>
                                <td style="border:1px solid #000; width:12%;"><strong>Modelo:</strong></td>
                                <td style="border:1px solid #000; width:21%;">
                                    <t t-esc="o.fleet_vehicle_id.model_id.name if o.fleet_vehicle_id.model_id else ''"/>
                                </td>
                                <td style="border:1px solid #000; width:12%;"><strong>Serie/Placa:</strong></td>
                                <td style="border:1px solid #000; width:22%;">
                                    <t t-esc="o.fleet_vehicle_id.license_plate or ''"/>
                                </td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #000;"><strong>Marca:</strong></td>
                                <td style="border:1px solid #000;">
                                    <t t-esc="o.fleet_vehicle_id.model_id.brand_id.name if (o.fleet_vehicle_id.model_id and 'brand_id' in o.fleet_vehicle_id.model_id._fields and o.fleet_vehicle_id.model_id.brand_id) else ''"/>
                                </td>
                                <td style="border:1px solid #000;"><strong>Año:</strong></td>
                                <td style="border:1px solid #000;">
                                    <t t-esc="(('model_year' in o.fleet_vehicle_id._fields and o.fleet_vehicle_id.model_year) or ('year' in o.fleet_vehicle_id._fields and o.fleet_vehicle_id.year) or '')"/>
                                </td>
                                <td style="border:1px solid #000;"><strong>Kilometraje:</strong></td>
                                <td style="border:1px solid #000;">
                                    <t t-esc="(('last_odometer' in o._fields and o.last_odometer) and ('%s' % o.last_odometer)) or ''"/>
                                </td>
                            </tr>
                        </t>
                        <t t-else="">
                            <tr>
                                <td style="border:1px solid #000; width:12%;"><strong>Equipo:</strong></td>
                                <td style="border:1px solid #000;" colspan="5">
                                    <t t-esc="o.equipment_id.name if o.equipment_id else ''"/>
                                </td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #000;"><strong>Marca:</strong></td>
                                <td style="border:1px solid #000;">
                                    <t t-esc="o.equipment_id.brand_id.name if (o.equipment_id and o.equipment_id.brand_id) else ''"/>
                                </td>
                                <td style="border:1px solid #000;"><strong>Modelo:</strong></td>
                                <td style="border:1px solid #000;">
                                    <t t-esc="o.equipment_id.model if (o.equipment_id and 'model' in o.equipment_id._fields) else ''"/>
                                </td>
                                <td style="border:1px solid #000;"><strong>Serie:</strong></td>
                                <td style="border:1px solid #000;">
                                    <t t-esc="o.equipment_id.serial_no if (o.equipment_id and 'serial_no' in o.equipment_id._fields) else ''"/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>

                <!-- 3. EVALUACIÓN -->
                <div style="margin-top:10px;">
                    <h4>3. EVALUACIÓN</h4>
                    <div t-if="o.technical_evaluation_html" t-raw="o.technical_evaluation_html"/>
                    <div t-if="not o.technical_evaluation_html" style="min-height:60px; border:1px solid #000; padding:8px;"></div>
                </div>

                <!-- 4. SISTEMAS EVALUADOS -->
                <div style="margin-top:10px;">
                    <h4>4. SISTEMAS EVALUADOS</h4>
                    <table class="table table-sm" style="width:100%; border:1px solid #000;">
                        <tbody>
                            <tr>
                                <td style="border:1px solid #000; width:25%;">Motor: <t t-esc="'X' if o.eval_engine else ''"/></td>
                                <td style="border:1px solid #000; width:25%;">Dirección: <t t-esc="'X' if o.eval_steering else ''"/></td>
                                <td style="border:1px solid #000; width:25%;">Suspensión: <t t-esc="'X' if o.eval_suspension else ''"/></td>
                                <td style="border:1px solid #000; width:25%;">Llantas: <t t-esc="'X' if o.eval_tires else ''"/></td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #000;">Transmisión: <t t-esc="'X' if o.eval_transmission else ''"/></td>
                                <td style="border:1px solid #000;">Eléctrico: <t t-esc="'X' if o.eval_electrical else ''"/></td>
                                <td style="border:1px solid #000;">Frenos: <t t-esc="'X' if o.eval_brakes else ''"/></td>
                                <td style="border:1px solid #000;">Chasis: <t t-esc="'X' if o.eval_chassis else ''"/></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 5. INTRODUCCIÓN -->
                <div style="margin-top:10px;">
                    <h4>5. INTRODUCCIÓN</h4>
                    <div t-if="o.technical_introduction_html" t-raw="o.technical_introduction_html"/>
                    <div t-if="not o.technical_introduction_html" style="min-height:60px; border:1px solid #000; padding:8px;"></div>
                </div>

                <!-- 6. EVIDENCIAS -->
                <div style="margin-top:10px;">
                    <h4>6. EVIDENCIAS</h4>
                    <t t-if="o.technical_evidence_ids">
                        <t t-foreach="o.technical_evidence_ids" t-as="ev">
                            <div style="border:1px solid #000; padding:8px; margin-bottom:8px;">
                                <div><strong><t t-esc="ev.name or ''"/></strong></div>
                                <div t-if="ev.description"><t t-esc="ev.description"/></div>
                                <div t-if="ev.image" style="margin-top:6px;">
                                    <img t-att-src="image_data_uri(ev.image)"
                                         style="max-height:260px; max-width:100%; height:auto; display:block;"/>
                                </div>
                            </div>
                        </t>
                    </t>
                    <t t-else="">
                        <div style="min-height:60px; border:1px solid #000; padding:8px;"></div>
                    </t>
                </div>

                <!-- 7. CONCLUSIONES (incluye Análisis / Cálculo) -->
                <div style="margin-top:10px;">
                    <h4>7. CONCLUSIONES</h4>


                    <div t-if="o.technical_conclusions_html" t-raw="o.technical_conclusions_html"/>
                    <div t-if="o.technical_waiting_response_text" style="margin-top:6px;"><t t-esc="o.technical_waiting_response_text"/></div>
                </div>

                <!-- Firma -->
                <div style="margin-top:20px;">
                    <div>Atentamente.</div>
                    <div style="margin-top:10px;">
                        <t t-if="'supervisor_employee_id' in o._fields and o.supervisor_employee_id and o.supervisor_employee_id.signature_html">
                            <div t-raw="o.supervisor_employee_id.signature_html"/>
                        </t>
                        <t t-else="">
                            <div style="margin-top:20px;">
                                <strong><t t-esc="o.supervisor_employee_id.name if 'supervisor_employee_id' in o._fields and o.supervisor_employee_id else ''"/></strong>
                            </div>
                        </t>
                    </div>
                </div>

            </div>
        </t>
    </template>

    <template id="report_maintenance_technical_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="estratego_maintenance_technical_report.report_maintenance_technical"/>
            </t>
        </t>
    </template>
</odoo>
